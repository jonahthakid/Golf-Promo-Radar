<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skratch Radar Widget</title>
    
    <!-- Fonts - Fjalla One (headers) and Inter (body) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fjalla+One&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        radar: {
                            black: '#050505',
                            dark: '#0a0a0a',
                            grid: '#1a1a1a',
                            green: '#ffffff',
                            greenDim: 'rgba(255, 255, 255, 0.2)',
                            red: '#ff3333',
                            white: '#e5e5e5'
                        }
                    },
                    fontFamily: {
                        loud: ['"Fjalla One"', 'sans-serif'],
                        tech: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'spin-slow': 'spin 4s linear infinite',
                        'scan': 'scan 4s linear infinite',
                        'flash': 'flash 2s infinite',
                    },
                    keyframes: {
                        scan: {
                            '0%': { transform: 'translateY(-100%)' },
                            '100%': { transform: 'translateY(100%)' }
                        },
                        flash: {
                            '0%, 100%': { opacity: 1 },
                            '50%': { opacity: 0.5 }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: transparent;
            color: #e5e5e5;
            overflow: hidden;
            text-transform: uppercase;
        }

        .widget-container {
            background-color: #050505;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
            border: 1px solid #1a1a1a;
            position: relative;
            padding-bottom: 16px;
        }

        .radar-sweep {
            background: conic-gradient(from 0deg, transparent 0deg, rgba(255, 255, 255, 0.1) 200deg, rgba(255, 255, 255, 0.8) 360deg);
            border-radius: 50%;
        }

        .widget-container:hover {
            border-color: #ffffff;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.15);
        }

        .code-tag {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body class="p-4 flex items-center justify-center min-h-screen">

    <!-- WIDGET START -->
    <div id="widget" class="widget-container w-[320px] h-[400px] flex flex-col group overflow-hidden rounded-xl">

        <!-- Header -->
        <div class="flex justify-between items-center p-3 border-b border-radar-grid bg-radar-dark/90 backdrop-blur">
            <div class="flex items-center gap-2">
                <svg width="100" height="50" viewBox="0 0 126 64" fill="none" xmlns="http://www.w3.org/2000/svg" class="h-5 w-auto">
                    <g clip-path="url(#clip_widget)">
                    <path d="M107.845 37.0542V54.4735C109.687 53.5255 111.412 52.5201 113.01 51.4643V39.8802C111.31 38.8819 109.588 37.9411 107.845 37.0542Z" fill="white"/>
                    <path d="M48.8327 12.0687C48.8327 11.3756 48.6347 10.8442 48.2388 10.4707C47.8429 10.0973 47.2915 9.968 46.5916 10.0865C45.7362 10.2337 44.8808 10.3881 44.0254 10.5569C44.0254 15.9863 44.0254 21.4157 44.0254 26.8415C45.2166 26.5147 46.1639 26.1054 46.8532 25.5847C47.5566 25.0568 48.0621 24.3853 48.3696 23.5594C48.6771 22.7335 48.8327 21.6958 48.8327 20.439C48.8327 17.6489 48.8327 14.8588 48.8327 12.0651V12.0687Z" fill="white"/>
                    <path d="M126 32.0018C126 14.3276 97.7926 0 63 0C28.2074 0 0 14.3276 0 32.0018C0 38.214 3.48174 44.0096 9.51204 48.9184C10.7386 48.1284 11.9793 47.3671 13.2306 46.6346V51.6259C14.5102 52.4625 15.8675 53.2633 17.3026 54.0318C17.4829 53.5506 17.5713 53.0407 17.5713 52.4949V48.9794C17.5713 47.5969 17.2461 46.3365 16.5992 45.209C15.9524 44.0851 15.0263 42.857 13.828 41.5535V41.4889C13.7467 41.4494 13.7078 41.3847 13.7078 41.2985C12.3116 39.7688 11.2688 38.3899 10.5619 37.1224C9.85491 35.8584 9.50497 34.343 9.50497 32.5691V26.5329C9.50497 24.4574 9.99983 22.5399 11.0037 20.8162C12.0076 19.0926 13.4604 17.6599 15.3868 16.5934C17.3168 15.5305 18.8191 15.333 19.8618 15.9255C20.9081 16.5216 21.4348 17.8717 21.4348 19.9473V30.0735C20.134 30.6804 18.8473 31.3123 17.5678 31.9767V22.784C17.5678 22.0048 17.3839 21.4734 17.0199 21.1897C16.6558 20.906 16.1079 20.9599 15.3868 21.3585C14.6622 21.7571 14.1249 22.3065 13.7643 22.9851C13.4038 23.6674 13.2271 24.3999 13.2271 25.1791V30.2818C13.2271 31.5817 13.5063 32.7271 14.0648 33.7254C14.6233 34.7273 15.5035 35.9482 16.7159 37.4204C16.7972 37.5281 16.8785 37.6359 16.9598 37.7472C18.3772 39.3343 19.4836 40.8605 20.2612 42.2789C21.0389 43.7008 21.4348 45.306 21.4348 47.0798V51.1052C21.4348 52.757 21.1025 54.2508 20.438 55.6046C31.6467 60.8221 46.5881 64.0108 62.9929 64.0108C79.3978 64.0108 92.9429 61.1165 103.957 56.3227V13.7817C105.262 14.3742 106.555 14.9955 107.838 15.649V33.0144C109.581 33.8978 111.302 34.8314 113.003 35.8225V18.4678C114.254 19.2004 115.498 19.9616 116.725 20.7552V48.7173C122.603 43.8516 125.993 38.1278 125.993 32.0018H126ZM37.5003 51.0226C36.1606 51.3817 34.8244 51.7731 33.4954 52.1896C31.7598 45.4496 30.0384 38.7634 28.3276 32.1203V53.9743C26.9985 54.477 25.6765 55.0085 24.3616 55.5686V12.8625C25.6765 12.3023 26.9985 11.7709 28.3276 11.2681V31.0969C30.0384 23.8433 31.7633 16.6365 33.4954 9.48348C34.8244 9.06694 36.157 8.67553 37.5003 8.31644C35.6198 15.5951 33.7499 22.9277 31.8941 30.3213C33.7499 37.1655 35.6198 44.0671 37.5003 51.0262V51.0226ZM49.8047 48.5413C48.2777 42.4153 46.7578 36.3252 45.2378 30.271C44.849 30.411 44.4461 30.5475 44.0254 30.6768C44.0254 36.9536 44.0254 43.2304 44.0254 49.5073C42.6469 49.7802 41.2718 50.0818 39.9039 50.4122V7.69882C41.2506 7.37205 42.6044 7.074 43.9583 6.80828C43.9583 6.80828 43.9759 6.80469 43.9865 6.8011C44.0007 6.8011 44.0113 6.79751 44.0254 6.79392C44.902 6.62156 45.7787 6.45997 46.6553 6.31274C48.6312 5.97879 50.1865 6.3271 51.3141 7.29305C52.4417 8.26258 53.0037 9.79947 53.0037 11.875V19.5989C53.0037 21.6781 52.6608 23.4304 51.9751 24.8703C51.2893 26.3139 50.2855 27.4809 48.9635 28.4073C48.9069 28.4468 48.8504 28.4827 48.7938 28.5222C50.4481 35.0002 52.1023 41.5176 53.7637 48.0817C52.4417 48.2074 51.1197 48.3618 49.8012 48.5413H49.8047ZM66.9801 47.7118C66.662 44.3256 66.3403 40.9395 66.0222 37.5533C64.071 37.4958 62.1163 37.4958 60.1651 37.5533C59.847 40.9395 59.5253 44.3256 59.2072 47.7118C57.811 47.7657 56.4112 47.8519 55.0185 47.9668C56.5773 33.6033 58.1362 19.2758 59.6985 4.98412C61.9396 4.90512 64.1806 4.90512 66.4217 4.98053C68.0052 19.2686 69.5888 33.5961 71.1688 47.9632C69.7726 47.8483 68.3764 47.7657 66.9801 47.7082V47.7118ZM84.5196 11.2681C82.876 10.9019 81.2217 10.5823 79.5674 10.3022C79.5674 23.2078 79.5674 36.1133 79.5674 49.0225C78.2065 48.7927 76.8421 48.5916 75.4742 48.4192C75.4742 35.5137 75.4742 22.6081 75.4742 9.69893C73.7633 9.48348 72.049 9.31111 70.3311 9.18543V5.19598C75.0924 5.5443 79.8361 6.24092 84.5231 7.28228V11.2717L84.5196 11.2681ZM99.5317 28.77C98.2097 28.2457 96.8771 27.7502 95.5375 27.2834V16.0548C95.5375 15.2755 95.336 14.5897 94.9295 13.9972C94.523 13.4047 93.9397 12.981 93.1692 12.7332C92.441 12.4998 91.8719 12.5537 91.4654 12.8876C91.0554 13.218 90.8539 13.7782 90.8539 14.5538V45.9703C90.8539 46.7495 91.0589 47.4246 91.4654 48.0027C91.8719 48.5808 92.441 48.9794 93.1692 49.2128C93.9397 49.4606 94.5265 49.4283 94.9295 49.1123C95.3324 48.7963 95.5375 48.2505 95.5375 47.4712V38.1242C96.8771 38.591 98.2097 39.0866 99.5317 39.6108V48.8286C99.5317 50.9077 98.998 52.2794 97.9199 52.976C96.8418 53.6727 95.2653 53.6475 93.1692 52.976C91.1155 52.3189 89.5284 51.3314 88.4255 49.9346C87.3227 48.5413 86.7677 46.8177 86.7677 44.7386V13.5807C86.7677 11.5051 87.3227 10.0472 88.4255 9.23571C89.5284 8.42776 91.1155 8.31285 93.1692 8.96639C95.2653 9.63788 96.8453 10.769 97.9199 12.2772C98.9944 13.7889 99.5317 15.5951 99.5317 17.6706V28.77Z" fill="white"/>
                    <path d="M60.5292 33.7182C62.2401 33.6715 63.9509 33.6715 65.6617 33.7182C64.8063 24.6476 63.9509 15.5879 63.0955 6.54248C62.2401 15.5915 61.3846 24.6512 60.5292 33.7217V33.7182Z" fill="white"/>
                    </g>
                    <defs>
                    <clipPath id="clip_widget">
                    <rect width="126" height="64" fill="white"/>
                    </clipPath>
                    </defs>
                </svg>
                <span class="font-loud text-xl tracking-wider text-white">RADAR</span>
            </div>
            <div class="text-[10px] text-white flex items-center gap-1">
                <span class="w-1.5 h-1.5 bg-radar-red rounded-full animate-pulse"></span>
                <span>LIVE</span>
            </div>
        </div>

        <!-- Radar Circle -->
        <div class="flex-1 flex items-center justify-center p-4">
            <div class="relative w-32 h-32 border border-radar-greenDim rounded-full bg-radar-black/50">
                <!-- Grid Rings -->
                <div class="absolute inset-0 border border-radar-greenDim rounded-full scale-75 opacity-50"></div>
                <div class="absolute inset-0 border border-radar-greenDim rounded-full scale-50 opacity-30"></div>
                
                <!-- Crosshairs -->
                <div class="absolute top-1/2 left-0 w-full h-px bg-radar-greenDim"></div>
                <div class="absolute left-1/2 top-0 h-full w-px bg-radar-greenDim"></div>

                <!-- Sweep -->
                <div class="absolute inset-0 radar-sweep animate-spin-slow origin-center"></div>
                
                <!-- Blips -->
                <div id="blips" class="absolute inset-0"></div>
            </div>
        </div>

        <!-- Deal Display -->
        <div id="deal-container" class="px-4 pb-2 transition-opacity duration-300">
            <div class="text-center">
                <div id="deal-brand" class="font-loud text-2xl text-white tracking-wide">SCANNING...</div>
                <div id="deal-desc" class="text-gray-400 text-xs mt-1 font-tech line-clamp-2 h-8">Acquiring targets</div>
            </div>
        </div>

        <!-- Discount + Code -->
        <div class="px-4 pb-1 h-12">
            <div class="flex items-center justify-center gap-2">
                <div id="deal-discount" class="font-loud text-2xl text-white tracking-wider">--% OFF</div>
                <div id="code-divider" class="w-px h-6 bg-radar-grid hidden"></div>
                <div id="deal-code" class="code-tag px-2 py-1 text-white text-sm font-tech hidden"></div>
            </div>
        </div>

        <!-- Footer -->
        <div class="flex justify-between items-center px-3 py-1 border-t border-radar-grid bg-radar-dark/90 text-[10px] text-gray-500 font-tech">
            <div class="flex items-center gap-2">
                <span class="text-radar-green"><i class="fas fa-crosshairs mr-1"></i><span id="stat-count">0</span> TARGETS</span>
            </div>
            <div id="stat-time" class="text-gray-600">00:00:00</div>
        </div>

        <!-- CTA Button -->
        <div class="px-3 pt-3 pb-4">
            <a id="cta-link" href="#" target="_blank" rel="noopener" class="block bg-gray-800 text-white font-loud text-sm text-center py-2 rounded-md tracking-wider hover:bg-gray-700 transition-colors">
                VIEW DEAL <i class="fas fa-arrow-right ml-1 text-xs"></i>
            </a>
        </div>
    </div>
    <!-- WIDGET END -->

    <script>
        // CONFIG - Auto-detect: use relative URL on same domain, full URL when embedded elsewhere
        const BASE_URL = window.location.hostname.includes('railway.app') || window.location.hostname.includes('skratch') 
            ? '' 
            : 'https://golf-promo-radar-production.up.railway.app';
        const API_URL = BASE_URL + '/api/promos';
        const RADAR_URL = BASE_URL || '/';

        // Elements
        const container = document.getElementById('deal-container');
        const brandEl = document.getElementById('deal-brand');
        const descEl = document.getElementById('deal-desc');
        const discountEl = document.getElementById('deal-discount');
        const codeEl = document.getElementById('deal-code');
        const codeDivider = document.getElementById('code-divider');
        const ctaEl = document.getElementById('cta-link');
        const blipsEl = document.getElementById('blips');
        const countEl = document.getElementById('stat-count');

        let widgetDeals = [];
        let currentIndex = 0;
        let currentDealUrl = RADAR_URL;

        // =================================================================
        // FETCH DEALS
        // =================================================================
        async function fetchDeals() {
            try {
                console.log('Fetching from:', API_URL);
                const response = await fetch(API_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Data received:', data);
                
                // Extract best deals
                const deals = [];
                
                // Get promos with discounts
                (data.promos || []).forEach(p => {
                    const discountMatch = p.promo?.match(/(\d+)%/);
                    if (discountMatch) {
                        const discount = discountMatch[1];
                        deals.push({
                            brand: p.brand.toUpperCase(),
                            desc: truncate(p.promo, 60),
                            discount: `${discount}% OFF`,
                            code: p.code || null,
                            url: p.affiliate_url || p.url || RADAR_URL,
                            priority: parseInt(discount)
                        });
                    } else if (p.promo) {
                        // Include deals without explicit % (e.g. "Free Shipping", "BOGO")
                        deals.push({
                            brand: p.brand.toUpperCase(),
                            desc: truncate(p.promo, 60),
                            discount: 'DEAL',
                            code: p.code || null,
                            url: p.affiliate_url || p.url || RADAR_URL,
                            priority: 5
                        });
                    }
                });
                
                // Get codes with discounts
                (data.codes || []).forEach(c => {
                    const discountMatch = c.discount?.match(/(\d+)%/);
                    if (discountMatch && c.code) {
                        const discount = discountMatch[1];
                        deals.push({
                            brand: c.brand.toUpperCase(),
                            desc: truncate(c.discount, 60),
                            discount: `${discount}% OFF`,
                            code: c.code,
                            url: c.affiliate_url || c.url || RADAR_URL,
                            priority: parseInt(discount)
                        });
                    }
                });
                
                // Add clearance
                (data.clearance || []).forEach(p => {
                    const discountMatch = p.promo?.match(/(\d+)%/);
                    if (discountMatch) {
                        const discount = discountMatch[1];
                        deals.push({
                            brand: p.brand.toUpperCase(),
                            desc: truncate(p.promo, 60),
                            discount: `${discount}% OFF`,
                            code: null,
                            url: p.affiliate_url || p.url || RADAR_URL,
                            priority: parseInt(discount)
                        });
                    }
                });
                
                // Add Impact partner deals
                (data.impactDeals || []).forEach(d => {
                    deals.push({
                        brand: d.brand.toUpperCase(),
                        desc: truncate(d.promo, 50),
                        discount: d.discount ? `${d.discount}% OFF` : 'PARTNER DEAL',
                        code: null,
                        url: d.affiliate_url || RADAR_URL,
                        priority: d.discount || 20
                    });
                });
                
                // Sort by priority (highest first) and take top 10
                deals.sort((a, b) => b.priority - a.priority);
                widgetDeals = deals.slice(0, 10);
                
                console.log('Processed deals:', deals.length);
                
                // Update count
                countEl.textContent = deals.length;
                
                // Generate random blips based on deal count
                generateBlips(Math.min(deals.length, 8));
                
                // Show first deal
                if (widgetDeals.length > 0) {
                    showDeal(widgetDeals[0]);
                } else {
                    brandEl.textContent = 'NO DEALS';
                    descEl.textContent = 'Check back soon';
                    discountEl.textContent = '--';
                }
                
            } catch (error) {
                console.error('Failed to fetch deals:', error);
                brandEl.textContent = 'SIGNAL LOST';
                descEl.textContent = 'Check console for errors';
                
                // Retry after 5 seconds
                setTimeout(fetchDeals, 5000);
            }
        }

        function truncate(str, len) {
            if (!str) return '';
            return str.length > len ? str.substring(0, len) + '...' : str;
        }

        // =================================================================
        // DISPLAY DEAL
        // =================================================================
        function showDeal(deal) {
            currentDealUrl = deal.url;
            ctaEl.href = deal.url;
            
            brandEl.textContent = deal.brand;
            descEl.textContent = deal.desc;
            discountEl.textContent = deal.discount;
            
            if (deal.code) {
                codeEl.textContent = deal.code;
                codeEl.classList.remove('hidden');
                codeDivider.classList.remove('hidden');
            } else {
                codeEl.classList.add('hidden');
                codeDivider.classList.add('hidden');
            }
            
            // Cipher effect
            cipherText(brandEl, deal.brand);
            cipherText(discountEl, deal.discount);
        }

        // =================================================================
        // CIPHER EFFECT
        // =================================================================
        function cipherText(element, finalString) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789%';
            let iterations = 0;
            const interval = setInterval(() => {
                element.innerText = finalString.split('')
                    .map((letter, index) => {
                        if (index < iterations) return finalString[index];
                        if (letter === ' ') return ' ';
                        return chars[Math.floor(Math.random() * chars.length)];
                    })
                    .join('');
                if (iterations >= finalString.length) clearInterval(interval);
                iterations += 0.5;
            }, 30);
        }

        // =================================================================
        // CYCLE DEALS
        // =================================================================
        function cycleDeals() {
            if (widgetDeals.length === 0) return;
            
            container.style.opacity = '0';
            
            setTimeout(() => {
                currentIndex = (currentIndex + 1) % widgetDeals.length;
                showDeal(widgetDeals[currentIndex]);
                container.style.opacity = '1';
            }, 300);
        }

        // =================================================================
        // GENERATE BLIPS
        // =================================================================
        function generateBlips(count) {
            blipsEl.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const blip = document.createElement('div');
                const angle = Math.random() * 360;
                const distance = 20 + Math.random() * 40;
                const x = 64 + Math.cos(angle * Math.PI / 180) * distance;
                const y = 64 + Math.sin(angle * Math.PI / 180) * distance;
                const isRed = Math.random() > 0.7;
                
                blip.className = `absolute w-1.5 h-1.5 rounded-full animate-ping ${isRed ? 'bg-radar-red' : 'bg-white'}`;
                blip.style.left = `${x}px`;
                blip.style.top = `${y}px`;
                blip.style.animationDelay = `${Math.random() * 2}s`;
                blipsEl.appendChild(blip);
            }
        }

        // =================================================================
        // CLOCK
        // =================================================================
        function updateClock() {
            const now = new Date();
            document.getElementById('stat-time').textContent = now.toISOString().substr(11, 8);
        }

        // =================================================================
        // INIT
        // =================================================================
        fetchDeals();
        setInterval(cycleDeals, 4000);
        setInterval(updateClock, 1000);
        setInterval(fetchDeals, 5 * 60 * 1000); // Refresh data every 5 mins
        updateClock();
    </script>
</body>
</html>
